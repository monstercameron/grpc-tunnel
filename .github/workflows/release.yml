name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.x'

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Build release binaries
      run: |
        # Create output directory
        mkdir -p dist
        
        # Build examples for Linux (library is platform-agnostic)
        echo "Building examples..."
        
        go build -ldflags="-s -w -X main.Version=${{ steps.get_version.outputs.VERSION }}" \
          -o "dist/grpc-tunnel-bridge" ./examples/direct-bridge
        
        go build -ldflags="-s -w -X main.Version=${{ steps.get_version.outputs.VERSION }}" \
          -o "dist/grpc-tunnel-server" ./examples/grpc-server
        
        # Build WASM client
        cd examples/wasm-client
        GOOS=js GOARCH=wasm go build -o ../../dist/main.wasm .
        cd ../..
        
        # Create archives
        cd dist
        tar czf GoGRPCBridge-examples.tar.gz GoGRPCBridge-bridge GoGRPCBridge-server
        tar czf GoGRPCBridge-wasm.tar.gz main.wasm

    - name: Generate changelog
      id: changelog
      run: |
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## Changes
          ${{ steps.changelog.outputs.CHANGELOG }}
          
          ## Installation
          
          This is a **Go library** for gRPC-over-WebSocket. Import it in your project:
          
          ```go
          import "github.com/monstercameron/grpc-tunnel/pkg/bridge"
          ```
          
          ### Example Binaries (Linux)
          
          Download example implementations:
          
          ```bash
          # Download and extract examples
          tar xzf grpc-tunnel-examples.tar.gz
          
          # Run bridge server
          ./grpc-tunnel-bridge
          
          # Run gRPC server
          ./grpc-tunnel-server
          ```
          
          ### WASM Client Example
          ```bash
          tar xzf grpc-tunnel-wasm.tar.gz
          # Deploy main.wasm with your web application
          ```
        files: |
          dist/*.tar.gz
        draft: false
        prerelease: false

  # Skipping Docker release - no Dockerfiles present in repository
  # Add Dockerfiles if needed for containerized deployments
